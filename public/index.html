<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase Loop Records Curator</title>
    <style>
        /* Base Styling + News List Image */
        body { font-family: Arial, sans-serif; background-color: #000000; color: #f0f0f0; margin: 0; padding: 20px; }
        .container { max-width: 600px; margin: auto; }
        h1, h2, h3 { color: #ffffff; border-bottom: 2px solid #555; padding-bottom: 10px; text-align: center; margin-bottom: 15px; }
        h3 { border-bottom: none; font-size: 1.1em; }
        .article { background-color: #111111; padding: 15px; margin-bottom: 10px; border-radius: 8px; cursor: pointer; border: 1px solid #333; display: flex; align-items: center; }
        .article-content { flex-grow: 1; }
        .article h2 { margin-top: 0; font-size: 1.2em; color: #ffffff; border-bottom: none; text-align: left; margin-bottom: 5px; }
        .article p { font-size: 0.8em; color: #ccc; margin-top: 0;}
        .article-image { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; margin-right: 15px; flex-shrink: 0; }

        /* UI State & Image Grid + Context Links */
        .hidden { display: none; }
        .image-selection-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 10px; }
        .image-container { display: flex; flex-direction: column; align-items: center; }
        .image-container img { width: 100%; height: 120px; object-fit: cover; cursor: pointer; border: 3px solid transparent; border-radius: 4px; margin-bottom: 5px; }
        .image-container img:hover { border-color: #555; }
        .image-container a { display: block; text-decoration: none; color: #aaa; font-size: 0.7em; text-align: center; margin-top: 2px; word-break: break-all; }
        .image-keyword { display: block; color: #777; font-size: 0.6em; text-align: center; margin-top: 1px; font-style: italic; }

        /* AI Text Preview Styling + Original Link */
        #ai-text-preview { padding: 15px; background-color: #1a1a1a; margin-bottom: 10px; border-radius: 4px; border: 1px solid #333; }
        #preview-headline { margin-top: 0; color: #FF6B6B; font-size: 1.4em; border-bottom: none; text-align: left;}
        #preview-description { font-size: 0.9em; color: #eee; margin-bottom: 10px;}
        #preview-caption-text { margin-top: 10px; font-style: italic; font-size: 0.9em; border-top: 1px dashed #333; padding-top: 10px; }
        #original-article-link-container { margin-bottom: 20px; text-align: center; font-size: 0.9em;}
        #original-article-link-container a { color: #87CEFA; text-decoration: none; }
        #original-article-link-container a:hover { text-decoration: underline; }


        #original-image-container img { width: 100%; max-width: 400px; margin: 10px auto; display: block; border: 2px solid #444; cursor: pointer; }
        #related-articles-list { display: flex; flex-direction: column; gap: 8px; }
        .related-article { background-color: #222; padding: 10px; border-radius: 4px; }
        .related-article a { color: #87CEFA; text-decoration: none; font-size: 0.9em; }
        .related-article p { font-size: 0.8em; color: #999; margin: 5px 0 0 0; }
        #video-display-area { margin-top: 20px; margin-bottom: 20px; }
        #video-display-area iframe,
        #video-display-area video { width: 100%; max-width: 560px; aspect-ratio: 16 / 9; display: block; margin: 0 auto; border: 1px solid #333; border-radius: 4px; }
        button { padding: 10px 15px; background-color: #007bff; color: white; border: none; cursor: pointer; border-radius: 4px; font-weight: bold; margin-top: 5px; }
        button:hover { background-color: #0056b3; }
        button#refresh-images-btn { background-color: #28a745; margin-left: 10px; }
        button#download-preview-btn { background-color: #17a2b8; margin-right: 10px; }
        button.back-button { background-color: #6c757d; margin-left: 10px;}
        button#share-preview-btn { background-color: #007bff; margin-right: 10px;}
        button#copy-caption-btn { background-color: #6f42c1; }
        button#copy-caption-btn:hover { background-color: #5a2e9b; }
        #simple-preview-image { width: 100%; max-width: 600px; margin: auto; display: block; margin-bottom: 20px; }
        #ai-caption-display { background-color: #1a1a1a; padding: 15px; margin-top: 20px; border-radius: 4px; border: 1px solid #333; }
        #ai-caption-display h3 { margin-top: 0; color: #FF6B6B; font-size: 1.4em; border-bottom: none; text-align: left;}
        #ai-caption-display #caption-text-area { width: 100%; height: 120px; background-color: #222; color: #f0f0f0; border: 1px solid #444; padding: 10px; box-sizing: border-box; resize: vertical; font-family: Arial, sans-serif; font-size: 0.9em; margin-bottom: 10px;}
        #simple-preview-video-player { width: 100%; max-width: 600px; aspect-ratio: 16 / 9; margin: auto; display: none; margin-bottom: 20px; border: 1px solid #444;}
    </style>
</head>
<body>
    <div class="container">
        <h1>PHASE LOOP RECORDS NEWS FEED</h1>
        <p>Tap a headline to create the social media post.</p>

        <div id="news-list"> Loading news... </div>

        <div id="selection-view" class="hidden">
             <h2>Select Your Post Visual</h2>
             <div id="ai-text-preview">
                 <h3 id="preview-headline">Generating AI text...</h3>
                 <p id="preview-description"></p>
                 <p id="preview-caption-text"></p>
             </div>
             <div id="original-article-link-container">
                 <a id="original-article-link" href="#" target="_blank" rel="noopener noreferrer">View Original Article</a>
             </div>
             <div id="original-image-container" class="hidden">
                 <h3>Original Article Image:</h3>
                 <img id="original-image" src="" alt="Original Article Image" />
             </div>
             <h3>Relevant Web Images: <button id="refresh-images-btn" disabled>Refresh</button></h3>
             <div id="image-selection-area" class="image-selection-grid">
                 <p>Generating AI text to determine search query...</p>
             </div>
             <div id="video-display-area" class="hidden">
                <h3>Related Video:</h3>
                <div id="video-player-container"></div>
             </div>
             <h3>Other Sources:</h3>
             <div id="related-articles-list">
                 <p>Finding related articles...</p>
             </div>
        </div>

        <div id="simple-preview-view" class="hidden">
            <h2>Quick Preview</h2>
            <img id="simple-preview-image" src="" alt="Simple Preview" />
            <div id="simple-preview-video-player" style="display: none;"></div>

            <div id="ai-caption-display">
                <h3>AI Caption:</h3>
                <textarea id="caption-text-area" readonly></textarea>
                <button id="copy-caption-btn">Copy Caption</button>
            </div>

            <button id="share-preview-btn">Share Post</button>
            <button id="download-preview-btn">Download Image</button>
            <button onclick="setView('select')" class="back-button">Back to Selection</button>
        </div>

    </div>

<script>
        // Global state (unchanged)
        let currentArticleData = null;
        // ... other state variables ...

        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM fully loaded and parsed. Calling fetchNews()..."); // Log 1
            fetchNews();
            // ... other listeners ...
        });


// --- UI VIEW HANDLERS (ADD LOGS) ---
        function setView(viewId) {
            console.log(`setView called with ID: ${viewId}`); // Log 1: Function called
            const newsList = document.getElementById('news-list');
            const selectionView = document.getElementById('selection-view');
            const simplePreviewView = document.getElementById('simple-preview-view');

            if (!newsList || !selectionView || !simplePreviewView) {
                console.error("setView Error: One or more view elements not found!"); // Log Error
                return;
            }
            console.log("setView: Found all view elements."); // Log 2: Elements found

            // Hide all views first
            newsList.classList.add('hidden');
            selectionView.classList.add('hidden');
            simplePreviewView.classList.add('hidden');
            console.log("setView: Added 'hidden' to all views."); // Log 3: Hidden applied

            // Show the target view
            if (viewId === 'list') {
                newsList.classList.remove('hidden');
                console.log("setView: Showing 'news-list'."); // Log 4a
            } else if (viewId === 'select') {
                selectionView.classList.remove('hidden');
                console.log("setView: Showing 'selection-view'."); // Log 4b
            } else if (viewId === 'simple-preview') {
                simplePreviewView.classList.remove('hidden');
                console.log("setView: Showing 'simple-preview-view'."); // Log 4c
                populateCaptionDisplay(); // Keep this logic here
            }
        }

        // --- Fetch News ---
        async function fetchNews() { /* ... unchanged ... */ }

        // --- Handle Tap ---
        async function handleArticleTap(article) {
             console.log("handleArticleTap called for:", article.title);
             // ... (rest of handleArticleTap - unchanged) ...
             setView('select'); // This calls the updated setView
             // ... (rest of handleArticleTap - unchanged) ...
         }

        // --- STEP 1: Fetch News (ADD LOGS) ---
        async function fetchNews() {
            console.log("fetchNews function STARTED."); // Log 2
            const newsListElement = document.getElementById('news-list');
            if (!newsListElement) {
                 console.error("CRITICAL ERROR: news-list element NOT FOUND!"); // Log Error
                 alert("Page structure error. Cannot load news."); // Alert user
                 return; // Stop execution
            }
            newsListElement.innerHTML = 'Loading news...';
            console.log("Set 'Loading news...' text."); // Log 3

            try {
                console.log("Inside try block, BEFORE fetch('/api/news')"); // Log 4
                const response = await fetch('/api/news');
                console.log("AFTER fetch('/api/news'), Status:", response.status); // Log 5 (Should see this if fetch works)

                if (!response.ok) {
                    console.error("Fetch response NOT ok:", response.status, response.statusText); // Log Error
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                console.log("Response OK. Trying response.json()..."); // Log 6
                const articles = await response.json();
                console.log("Successfully parsed JSON. Number of articles:", articles ? articles.length : 'null/undefined'); // Log 7

                if (!articles || articles.length === 0) {
                    newsListElement.innerHTML = '<p>No news articles found.</p>';
                    console.log("No articles found in response data."); // Log Info
                    return;
                }

                newsListElement.innerHTML = ''; // Clear loading message
                console.log("Cleared loading message. Starting article loop..."); // Log 8

                articles.forEach((article, index) => {
                    // console.log(`Processing article ${index}: ${article.title}`); // Optional: Log each article
                    const articleElement = document.createElement('div');
                    articleElement.className = 'article';
                    articleElement.dataset.link = article.link;

                    const imgElement = document.createElement('img');
                    imgElement.className = 'article-image';
                    imgElement.src = article.originalImageUrl || '/fallback-thumbnail.png';
                    imgElement.alt = 'Article thumbnail';
                    imgElement.onerror = function() { this.src='/fallback-thumbnail.png'; };

                    const contentElement = document.createElement('div');
                    contentElement.className = 'article-content';
                    contentElement.innerHTML = `<h2>${article.title}</h2><p>Source: ${article.source} | Published: ${new Date(article.pubDate).toLocaleDateString()}</p>`;

                    articleElement.appendChild(imgElement);
                    articleElement.appendChild(contentElement);
                    articleElement.onclick = () => handleArticleTap(article);
                    newsListElement.appendChild(articleElement);
                });
                console.log("Finished processing all articles."); // Log 9

            } catch (error) {
                console.error('!!! CATCH ERROR inside fetchNews:', error); // Log Catch Error
                newsListElement.innerHTML = '<p style="color: red;">Failed to load news. Check console.</p>';
            }
        }

        // ... (Rest of your JavaScript functions: handleArticleTap, fetchAiText, etc.)

// --- *** ENSURE THIS FUNCTION DEFINITION EXISTS AND IS SPELLED CORRECTLY *** ---
        async function handleArticleTap(article) {
             console.log("handleArticleTap called for:", article.title); // Add log to confirm it's called
             currentArticleData = article;
             currentCuratedData = null;
             currentVideoUrl = null;
             simplePreviewImagePath = null;
             currentSearchKeywords = [];
             currentKeywordIndex = 0;
             refreshClicksOnCurrentKeyword = 0;
             currentImageStartIndex = 0;
             document.getElementById('refresh-images-btn').disabled = true;

             setView('select');

             // Reset UI sections
             document.getElementById('preview-headline').innerText = "Generating AI text...";
             document.getElementById('preview-description').innerText = "";
             document.getElementById('preview-caption-text').innerText = "";
             document.getElementById('image-selection-area').innerHTML = "<p>Generating AI text to determine search query...</p>";
             document.getElementById('related-articles-list').innerHTML = "<p>Finding related articles...</p>";
             document.getElementById('video-display-area').classList.add('hidden');
             document.getElementById('video-player-container').innerHTML = '';
             document.getElementById('original-image-container').classList.add('hidden');

             // Set original article link
             const originalLinkEl = document.getElementById('original-article-link');
             originalLinkEl.href = article.link;
             originalLinkEl.textContent = `View Original Article on ${article.source}`;

             // Call AI Text FIRST
             fetchAiText(article);

             // Call other non-dependent APIs
             fetchRelatedArticles(article.title, article.source);
             fetchVideo(article.title, article.source, article.videoUrl);

             // Handle original image
             if (article.originalImageUrl) {
                const originalImgEl = document.getElementById('original-image');
                const originalImgContainer = document.getElementById('original-image-container');
                originalImgEl.src = article.originalImageUrl;
                originalImgEl.onclick = () => startSimplePreviewPipeline(article.originalImageUrl);
                originalImgContainer.classList.remove('hidden');
            }
         }
        // --- *** END FUNCTION DEFINITION CHECK *** ---


        // --- Fetch AI Text ---
        async function fetchAiText(article) { /* ... */ }
        // --- Fetch Primary Keywords ---
        async function fetchPrimaryKeywordsAndStartImageSearch(headline, description) { /* ... */ }
        // --- Fetch Alternative Keywords ---
        async function fetchAlternativeKeywords() { /* ... */ }
        // --- Fetch Images ---
        async function fetchImages(query, startIndex) { /* ... */ }
        // --- Fetch Related Articles ---
        async function fetchRelatedArticles(title, source) { /* ... */ }
        // --- Fetch Video ---
        async function fetchVideo(title, source, rssVideoUrl) { /* ... */ }
        // --- Display Video ---
        function displayVideo(videoUrl, containerId) { /* ... */ }
        // --- Call Simple Preview API ---
        async function startSimplePreviewPipeline(mediaUrl) { /* ... */ }
        // --- Populate Caption Display ---
        function populateCaptionDisplay() { /* ... */ }
        // --- Handle Copy Caption ---
        async function handleCopyCaption() { /* ... */ }
        // --- Share Button Logic ---
        async function handleShare() { /* ... */ }
        // --- Download Button Logic ---
        function handleDownload() { /* ... */ }


    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <!-- ... (Meta, Title, Styles unchanged) ... -->
    <style>
      /* ... All styles unchanged ... */
    </style>
</head>
<body>
    <div class="container">
        <!-- ... (H1, P, news-list unchanged) ... -->

        <div id="selection-view" class="hidden">
             <!-- ... (H2, AI Text Preview, Original Link, Original Image unchanged) ... -->

             <!-- Web Images Area -->
             <h3>Relevant Web Images: <button id="refresh-images-btn" disabled>Refresh</button></h3>
             <div id="image-selection-area" class="image-selection-grid">
                 <p>Generating AI text to determine search query...</p>
             </div>
             <!-- ... (Video Area, Related Articles Area unchanged) ... -->
        </div>

        <div id="simple-preview-view" class="hidden"> /* ... unchanged ... */ </div>
    </div>

    <script>
        // Global state
        let currentArticleData = null;
        let currentCuratedData = null;
        let simplePreviewImagePath = null;
        let currentVideoUrl = null;
        const IMAGES_PER_PAGE = 9;

        // *** UPDATED State for Image Search Pagination & Keywords ***
        let currentSearchKeywords = []; // Array of keywords tried
        let currentKeywordIndex = 0;    // Index of the keyword currently being used
        let refreshClicksOnCurrentKeyword = 0; // Clicks since last keyword change (0, 1, 2)
        let currentImageStartIndex = 0; // 0-based index for pagination within current keyword


        document.addEventListener('DOMContentLoaded', () => {
            fetchNews();

            // *** UPDATED Refresh button listener ***
            document.getElementById('refresh-images-btn').onclick = () => {
                if (currentSearchKeywords.length === 0 || !currentCuratedData) {
                    alert('Cannot refresh: search keywords not set or AI data missing.'); return;
                }

                refreshClicksOnCurrentKeyword++; // Increment clicks on this keyword

                if (refreshClicksOnCurrentKeyword < 3) {
                    // --- Load next page for CURRENT keyword ---
                    currentImageStartIndex += IMAGES_PER_PAGE; // Go to next page index
                    const currentKeyword = currentSearchKeywords[currentKeywordIndex];
                    console.log(`[Refresh] Loading next images for "${currentKeyword}", starting at index ${currentImageStartIndex}`);
                    fetchImages(currentKeyword, currentImageStartIndex);
                } else {
                    // --- Time to get an ALTERNATIVE keyword ---
                    console.log(`[Refresh] Reached 3 clicks, requesting alternative keywords...`);
                     // Disable button while fetching alternative
                    document.getElementById('refresh-images-btn').disabled = true;
                    fetchAlternativeKeywords(); // This will handle fetching and starting the new search
                }
            };

            // Other listeners (Unchanged)
            document.getElementById('download-preview-btn').onclick = () => handleDownload();
            document.getElementById('share-preview-btn').onclick = () => handleShare();
            document.getElementById('copy-caption-btn').onclick = () => handleCopyCaption();
        });

        // --- UI VIEW HANDLERS (Unchanged) ---
        function setView(viewId) { /* ... unchanged ... */ }

        // --- Fetch News (Unchanged) ---
        async function fetchNews() { /* ... unchanged ... */ }

        // --- Handle Tap (*** UPDATED to reset ALL keyword/pagination state ***) ---
        async function handleArticleTap(article) {
             currentArticleData = article;
             currentCuratedData = null;
             currentVideoUrl = null;
             simplePreviewImagePath = null;

             // *** Reset ALL image search state ***
             currentSearchKeywords = [];
             currentKeywordIndex = 0;
             refreshClicksOnCurrentKeyword = 0;
             currentImageStartIndex = 0;
             document.getElementById('refresh-images-btn').disabled = true; // Disable refresh initially
             // *** End Reset ***

             setView('select');

             // Reset UI sections (unchanged)
             // ...
             document.getElementById('image-selection-area').innerHTML = "<p>Generating AI text to determine search query...</p>";
             // ...

             // Set original article link (unchanged)
             // ...

             // Call AI Text FIRST (unchanged)
             fetchAiText(article);

             // Call other non-dependent APIs (unchanged)
             fetchRelatedArticles(article.title, article.source);
             fetchVideo(article.title, article.source, article.videoUrl);

             // Handle original image (unchanged)
             if (article.originalImageUrl) { /* ... */ }
         }

        // --- Fetch AI Text (*** UPDATED: Triggers primary keyword extraction ***) ---
        async function fetchAiText(article) {
             // ... (fetches AI text and populates fields - unchanged until the end) ...
            try {
                 // ... fetch /api/generate-text ...
                 currentCuratedData = await response.json();
                 // ... populate UI ...

                // *** Trigger PRIMARY keyword extraction ***
                if (currentCuratedData.headline && currentCuratedData.headline !== "AI Failed") {
                     fetchPrimaryKeywordsAndStartImageSearch(currentCuratedData.headline, currentCuratedData.description);
                } else { /* ... fallback as before ... */ }

            } catch (error) { /* ... error handling and fallback as before ... */ }
        }

        // --- Fetch Primary Keywords & Trigger Image Search (Renamed, logic mostly same) ---
        async function fetchPrimaryKeywordsAndStartImageSearch(headline, description) {
            document.getElementById('image-selection-area').innerHTML = '<p>Extracting primary keywords for image search...</p>';
            try {
                // NOTE: Using the *same* endpoint as before for initial extraction
                const response = await fetch('/api/extract-keywords', {
                     method: 'POST', headers: { 'Content-Type': 'application/json' },
                     body: JSON.stringify({ headline, description })
                 });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();

                let primaryKeyword = data.keywords; // Get keyword from AI

                if (!primaryKeyword) { // Fallback if AI fails
                    console.warn("[Keywords] Primary extraction failed, falling back to article title.");
                    primaryKeyword = currentArticleData.title; // Use original title
                    document.getElementById('image-selection-area').innerHTML = '<p>Keyword extraction failed, using article title...</p>';
                }

                // *** Initialize search state ***
                currentSearchKeywords = [primaryKeyword]; // Start with the first keyword
                currentKeywordIndex = 0;
                refreshClicksOnCurrentKeyword = 0;
                currentImageStartIndex = 0;
                console.log(`[Keywords] Received primary keyword: "${primaryKeyword}", starting image search.`);
                fetchImages(primaryKeyword, 0); // Start image search

            } catch (error) { /* ... error handling and fallback as before ... */ }
        }

        // --- *** NEW FUNCTION: Fetch Alternative Keywords *** ---
        async function fetchAlternativeKeywords() {
             if (!currentCuratedData) {
                 alert("Cannot get alternative keywords without AI text.");
                 document.getElementById('refresh-images-btn').disabled = false; // Re-enable if stuck
                 return;
             }
             const area = document.getElementById('image-selection-area');
             area.innerHTML += '<p>Searching for alternative keywords...</p>'; // Append message

             try {
                const response = await fetch('/api/get-alternative-keywords', {
                     method: 'POST',
                     headers: { 'Content-Type': 'application/json' },
                     body: JSON.stringify({
                         headline: currentCuratedData.headline,
                         description: currentCuratedData.description,
                         previousKeywords: currentSearchKeywords // Send keywords already tried
                     })
                 });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();

                if (data.keywords) {
                    const newKeyword = data.keywords;
                    console.log(`[AltKeywords] Received alternative: "${newKeyword}"`);
                    // Add to list, update index, reset counters
                    currentSearchKeywords.push(newKeyword);
                    currentKeywordIndex++;
                    refreshClicksOnCurrentKeyword = 0; // Reset click count for the new keyword
                    currentImageStartIndex = 0;      // Reset pagination for the new keyword
                    // Start search with the new keyword
                    fetchImages(newKeyword, 0);
                } else {
                    // AI couldn't find a different keyword
                    console.warn("[AltKeywords] AI could not provide a suitable alternative keyword.");
                    alert("No more alternative keywords found by AI.");
                    // Keep refresh button disabled as we've exhausted options for now
                    area.innerHTML += '<p>No alternative keywords found.</p>';
                    document.getElementById('refresh-images-btn').disabled = true;
                }

            } catch (error) {
                 console.error("Error fetching alternative keywords:", error);
                 alert("Failed to get alternative keywords.");
                 // Re-enable button on error so user might try again? Or keep disabled? Keep disabled.
                 area.innerHTML += '<p>Failed to get alternative keywords.</p>';
                 document.getElementById('refresh-images-btn').disabled = true;
             }
        }


        // --- Fetch Images (Unchanged logic, just ensure button state) ---
        async function fetchImages(query, startIndex) {
            const area = document.getElementById('image-selection-area');
            const refreshBtn = document.getElementById('refresh-images-btn');

            // Update loading message based on whether it's a new keyword or pagination
             const isLoadingNewKeyword = startIndex === 0 && refreshClicksOnCurrentKeyword === 0 && currentKeywordIndex > 0;
             if (startIndex === 0 && !isLoadingNewKeyword) area.innerHTML = `<p>Searching for images: "${query}"...</p>`;
             else if (isLoadingNewKeyword) area.innerHTML = `<p>Trying alternative keyword: "${query}"...</p>`; // Specific message
             else area.innerHTML += `<p>Loading more images...</p>`;

             refreshBtn.disabled = true; // Disable while fetching

            try {
                // ... (fetch call using query, startIndex - unchanged) ...
                const response = await fetch('/api/search-images', { /* ... */ });
                const data = await response.json();
                const imagesData = data.images || [];

                // Clean up loading messages
                if (startIndex === 0) { area.innerHTML = ''; }
                else {
                    const loadingP = area.querySelector('p:last-child');
                    if (loadingP && loadingP.textContent.includes('Loading')) area.removeChild(loadingP);
                }

                if (imagesData.length === 0) {
                     if (startIndex === 0) { area.innerHTML = `<p>No relevant images found for "${query}".</p>`; }
                     else { area.innerHTML += `<p>No more images found for "${query}".</p>`; }
                     // Keep button disabled ONLY if no results found on first page for this keyword
                     refreshBtn.disabled = (startIndex === 0);
                } else {
                    refreshBtn.disabled = false; // Re-enable if results found
                     // Append images (unchanged logic with keyword display)
                     imagesData.forEach((imgData, index) => { /* ... append image, link, keyword ... */ });
                 }

            } catch (error) { /* ... error handling ... */ }
        }

        // --- Fetch Related Articles (unchanged) ---
        async function fetchRelatedArticles(title, source) { /* ... unchanged ... */ }
        // --- Fetch Video (unchanged) ---
        async function fetchVideo(title, source, rssVideoUrl) { /* ... unchanged ... */ }
        // --- Display Video (unchanged) ---
        function displayVideo(videoUrl, containerId) { /* ... unchanged ... */ }

        // --- Call Simple Preview API (*** UPDATED to reset counts ***) ---
        async function startSimplePreviewPipeline(mediaUrl) {
            // ... (rest of function unchanged until success part) ...
            try {
                 if (/* preview generation successful or video setup done */) {
                    setView('simple-preview');
                     // *** Reset image search pagination state after selection ***
                     currentImageStartIndex = 0;
                     refreshClicksOnCurrentKeyword = 0; // Reset clicks too
                     // Keep current keyword index and array
                     document.getElementById('refresh-images-btn').disabled = false;
                 }
            } catch (error) { /* ... error handling ... */ }
        }

        // --- Populate Caption Display (unchanged) ---
        function populateCaptionDisplay() { /* ... unchanged ... */ }
        // --- Handle Copy Caption (unchanged) ---
        async function handleCopyCaption() { /* ... unchanged ... */ }
        // --- Share Button Logic (*** UPDATED to reset counts ***) ---
        async function handleShare() {
            // ... (checks and share logic unchanged) ...
            if (navigator.share) {
                try {
                    await navigator.share(shareData);
                    alert('Shared successfully!');
                    // *** Reset image search pagination state after sharing ***
                     currentImageStartIndex = 0;
                     refreshClicksOnCurrentKeyword = 0; // Reset clicks too
                     document.getElementById('refresh-images-btn').disabled = false;

                } catch (err) { /* ... error handling ... */ }
            } else { /* ... fallback ... */ }
        }

        // --- Download Button Logic (*** UPDATED to reset counts ***) ---
        function handleDownload() {
            let didDownload = false;
            // ... (video/image download logic unchanged) ...
            if (didDownload) {
                // *** Reset image search pagination state after download/open ***
                currentImageStartIndex = 0;
                refreshClicksOnCurrentKeyword = 0; // Reset clicks too
                document.getElementById('refresh-images-btn').disabled = false;
            }
        }

    </script>
</body>
</html>

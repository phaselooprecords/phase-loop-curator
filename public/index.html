<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase Loop Records Curator</title>
    <style>
        /* Base Styling */
        body { font-family: Arial, sans-serif; background-color: #000000; color: #f0f0f0; margin: 0; padding: 20px; }
        .container { max-width: 600px; margin: auto; }
        h1, h2, h3 { color: #ffffff; border-bottom: 2px solid #555; padding-bottom: 10px; text-align: center; margin-bottom: 15px; }
        h3 { border-bottom: none; font-size: 1.1em; }
        .article { background-color: #111111; padding: 15px; margin-bottom: 10px; border-radius: 8px; cursor: pointer; border: 1px solid #333; }
        .article:hover { background-color: #222222; }
        .article h2 { margin-top: 0; font-size: 1.2em; color: #ffffff; border-bottom: none; text-align: left;}
        .article p { font-size: 0.8em; color: #ccc; }

        /* UI State & Image Grid */
        .hidden { display: none; }
        .image-selection-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 10px; }
        .image-selection-grid a { display: block; text-decoration: none; color: #aaa; font-size: 0.7em; text-align: center; }
        .image-selection-grid img { width: 100%; height: 120px; object-fit: cover; cursor: pointer; border: 3px solid transparent; border-radius: 4px; margin-bottom: 5px; }
        .image-selection-grid img:hover { border-color: #555; }

        /* AI Text Preview Styling */
        #ai-text-preview { padding: 15px; background-color: #1a1a1a; margin-bottom: 20px; border-radius: 4px; border: 1px solid #333; }
        #preview-headline { margin-top: 0; color: #FF6B6B; font-size: 1.4em; border-bottom: none; text-align: left;}
        #preview-caption-text { margin-top: 10px; font-style: italic; font-size: 0.9em; border-top: 1px dashed #333; padding-top: 10px; }

        #original-image-container img { width: 100%; max-width: 400px; margin: 10px auto; display: block; border: 2px solid #444; cursor: pointer; }

        /* Button Styling */
        button { padding: 10px 15px; background-color: #007bff; color: white; border: none; cursor: pointer; border-radius: 4px; font-weight: bold; margin-top: 5px; }
        button:hover { background-color: #0056b3; }
        button#refresh-images-btn { background-color: #28a745; margin-left: 10px; }
        button#download-preview-btn { background-color: #17a2b8; margin-right: 10px; }
        button.back-button { background-color: #6c757d; margin-left: 10px;}
        button#share-preview-btn { background-color: #007bff; margin-right: 10px;}

        input[type="text"], textarea { background-color: #1a1a1a; color: white; border: 1px solid #333; width: 98%; padding: 8px; margin-bottom: 15px; }

        /* Simple Preview Styling */
        #simple-preview-image { width: 100%; max-width: 600px; margin: auto; display: block; margin-bottom: 20px; }
        
        /* Loading Indicator Styling */
        #loading-view { text-align: center; padding: 50px; font-size: 1.2em; color: #ccc; }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top: 4px solid #fff; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <h1>PHASE LOOP RECORDS NEWS FEED</h1>
        <p>Tap a headline to create the social media post.</p>

        <div id="news-list"> Loading news... </div>

        <div id="loading-view" class="hidden">
            <div class="spinner"></div>
            <p>Content is being created...</p>
        </div>
        
        <div id="selection-view" class="hidden">
             <h2>Select Your Post Visual</h2>
             <div id="ai-text-preview">
                 <h3 id="preview-headline"></h3>
                 <p id="preview-description"></p>
                 <p id="preview-caption-text"></p>
             </div>
             <div id="original-image-container" class="hidden">
                 <h3>Original Article Image:</h3>
                 <img id="original-image" src="" alt="Original Article Image" />
             </div>
             <h3>Relevant Web Images: <button id="refresh-images-btn">Refresh</button></h3>
             <div id="image-selection-area" class="image-selection-grid">
                 {/* Images go here */}
             </div>
        </div>

        <div id="simple-preview-view" class="hidden">
            <h2>Quick Preview</h2>
            <img id="simple-preview-image" src="" alt="Simple Preview" style="width: 100%; max-width: 600px; margin: auto; display: block; margin-bottom: 20px;" />
            
            <div style="margin-top: 10px; padding: 15px; background-color: #1a1a1a; border-radius: 4px; border: 1px solid #333;">
                <h3 style="margin-top:0; border-bottom: none; text-align: left;">AI Caption:</h3>
                <p id="final-caption-display" style="font-size: 0.9em; color: #ccc; white-space: pre-wrap; margin-bottom: 10px;"></p>
                <button id="copy-caption-btn" style="background-color: #5cb85c; margin-top: 10px;">Copy Caption</button>
            </div>
            
            <div style="margin-top: 20px; text-align: center;">
                <button id="share-preview-btn">Share Post</button>
                <button id="download-final-image-btn">Download Final Image</button>
                <button onclick="setView('select')" class="back-button">Back to Selection</button>
            </div>
        </div>

    </div>

    <script>
        // Global state
        let currentArticleData = null;
        let currentCuratedData = null;
        let allRelevantImages = [];
        let currentImagePage = 0;
        let simplePreviewImagePath = null;

        document.addEventListener('DOMContentLoaded', () => {
            fetchNews();
            // Attach button listeners to their CORRECT IDs
            document.getElementById('refresh-images-btn').onclick = () => { currentImagePage++; showImageSelectionUI(); };
            
            // --- BUTTON LISTENERS FIXED ---
            document.getElementById('download-final-image-btn').onclick = () => handleDownloadFinalImage();
            document.getElementById('share-preview-btn').onclick = () => handleShare();
            document.getElementById('copy-caption-btn').onclick = () => handleCopyCaption(); 
            document.getElementById('back-to-selection-btn').onclick = () => setView('select'); 
        });

        // --- UI VIEW HANDLERS ---
        function setView(viewId) {
            document.getElementById('news-list').classList.add('hidden');
            document.getElementById('loading-view').classList.add('hidden');
            document.getElementById('selection-view').classList.add('hidden');
            document.getElementById('simple-preview-view').classList.add('hidden');

            if (viewId === 'list') document.getElementById('news-list').classList.remove('hidden');
            else if (viewId === 'loading') document.getElementById('loading-view').classList.remove('hidden');
            else if (viewId === 'select') document.getElementById('selection-view').classList.remove('hidden');
            else if (viewId === 'simple-preview') document.getElementById('simple-preview-view').classList.remove('hidden');
        }

        // --- STEP 1: Fetch News ---
        async function fetchNews() {
            const newsListElement = document.getElementById('news-list');
            newsListElement.innerHTML = 'Loading news...';
            try {
                const response = await fetch('/api/news');
                if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
                const articles = await response.json();

                if (!articles || articles.length === 0) { newsListElement.innerHTML = '<p>No news articles found.</p>'; return; }
                newsListElement.innerHTML = '';
                articles.forEach(article => {
                    const articleElement = document.createElement('div');
                    articleElement.className = 'article';
                    articleElement.dataset.link = article.link;
                    articleElement.innerHTML = `<h2>${article.title}</h2><p>Source: ${article.source} | Published: ${new Date(article.pubDate).toLocaleDateString()}</p>`;
                    articleElement.addEventListener('click', () => handleArticleTap(article));
                    newsListElement.appendChild(articleElement);
                });
            } catch (error) {
                console.error('Error fetching news:', error);
                newsListElement.innerHTML = '<p style="color: red;">Failed to load news.</p>';
            }
        }

        // --- STEP 2: Handle Tap & AI Curation ---
        async function handleArticleTap(article) {
             currentArticleData = article;
             setView('loading'); // Show loading indicator
             
             try {
                 const response = await fetch('/api/curate', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(article) });
                 currentCuratedData = await response.json();

                 if (currentCuratedData.headline === "AI Generation Failed") {
                    alert('AI text generation FAILED. Check console/API key. Returning to list.');
                    setView('list'); 
                    return;
                 }

                 allRelevantImages = currentCuratedData.images || [];
                 currentImagePage = 0; // Reset page count on new article
                 
                 showImageSelectionUI(); 

             } catch (error) {
                 console.error('Error during curation API call:', error);
                 alert('Connection error during curation. Returning to list.');
                 setView('list'); 
             }
         }

        // --- STEP 3: Show Image Selection UI ---
        function showImageSelectionUI() {
            setView('select');
            // Inject AI Text
            document.getElementById('preview-headline').innerText = currentCuratedData.headline || "N/A";
            document.getElementById('preview-description').innerText = currentCuratedData.description || "N/A";
            document.getElementById('preview-caption-text').innerText = (currentCuratedData.caption || "Caption N/A") + `\n\nNews Source: ${currentCuratedData.originalSource || 'Unknown'}`;
            // Show Original Image
            const originalImgEl = document.getElementById('original-image');
            const originalImgContainer = document.getElementById('original-image-container');
            if (currentArticleData.originalImageUrl) {
                originalImgEl.src = currentArticleData.originalImageUrl;
                originalImgEl.onclick = () => startSimplePreviewPipeline(currentArticleData.originalImageUrl);
                originalImgContainer.classList.remove('hidden');
            } else { originalImgContainer.classList.add('hidden'); }
            // Show Relevant Web Images
            const area = document.getElementById('image-selection-area');
            area.innerHTML = '';
            const startIndex = currentImagePage * 3;
            const imagesToShow = allRelevantImages.slice(startIndex, startIndex + 3);
            if (imagesToShow.length === 0) {
                if (currentImagePage === 0 && allRelevantImages.length === 0) { area.innerHTML = "<p>No relevant images found.</p>"; }
                else { currentImagePage = 0; showImageSelectionUI(); } return;
            }
            imagesToShow.forEach((imageUrl, index) => {
                const container = document.createElement('div');
                const img = document.createElement('img');
                img.src = imageUrl; img.alt = `Relevant Image ${startIndex + index + 1}`;
                img.onerror = function() { this.alt='Image failed'; this.style.border='1px solid red'; };
                img.onclick = () => startSimplePreviewPipeline(imageUrl);
                const link = document.createElement('a');
                link.href = currentArticleData.link; link.textContent = 'View Source Article';
                link.target = '_blank'; link.style.marginTop = '5px';
                container.appendChild(img); container.appendChild(link); area.appendChild(container);
            });
        }

        // --- STEP 3.5: Call Simple Preview API & Show Simple Preview ---
        async function startSimplePreviewPipeline(imageUrl) {
            const headline = (currentCuratedData.headline || "Headline N/A").replace(/^\*\*|\*\*$/g, '');
            const description = currentCuratedData.description;
            try {
                const response = await fetch('/api/generate-simple-preview', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ imageUrl, headline, description })
                });
                const previewData = await response.json();
                if (previewData.error || previewData.previewImagePath === '/fallback.png') { alert('Preview Error.'); return; }
                simplePreviewImagePath = previewData.previewImagePath;
                setView('simple-preview');
                document.getElementById('simple-preview-image').src = simplePreviewImagePath + '?' + Date.now();
                
                // --- NEW: Inject Caption into Preview Screen AFTER SUCCESSFUL IMAGE GENERATION ---
                const finalCaptionForDisplay = (currentCuratedData?.caption || "No caption available.") +
                                              `\n\nNews Source: ${currentCuratedData?.originalSource || 'Unknown'}`;
                document.getElementById('final-caption-display').innerText = finalCaptionForDisplay;

            } catch (error) { console.error('Error generating simple preview:', error); alert('Connection error.'); }
        }
        
        // --- Copy Caption Logic ---
        async function handleCopyCaption() {
            // Get caption from the display element
            const finalCaption = document.getElementById('final-caption-display').innerText;
            if (!finalCaption) { alert("No caption to copy."); return; }
            try {
                await navigator.clipboard.writeText(finalCaption);
                alert("Caption copied to clipboard!");
            } catch (err) {
                console.error("Could not copy text: ", err);
                alert("Failed to copy caption. Please copy it manually.");
            }
        }
        
        // --- Download Button Logic ---
        function handleDownloadFinalImage() {
            if (!simplePreviewImagePath) { alert("No image generated yet."); return; }
            const link = document.createElement('a');
            link.href = simplePreviewImagePath;
            const cleanedHeadlineText = (currentCuratedData?.headline || 'phaseloop-post').replace(/^\*\*|\*\*$/g, '').replace(/[^a-z0-9]/gi, '_').toLowerCase();
            link.download = `${cleanedHeadlineText}.png`;
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }

        // --- Share Button Logic ---
        async function handleShare() {
             if (!simplePreviewImagePath) { alert("No image generated yet."); return; }
             const finalCaption = document.getElementById('final-caption-display').innerText; // Use text from display
             const platform = prompt(
                 "Select platform to share to:\n\n1. Instagram Post\n2. Instagram Story (Restricted)\n3. TikTok Post\n4. Facebook\n5. Twitter"
             );
             if (!platform) return;
             let platformName;
             switch (platform.trim()) {
                 case '1': platformName = 'Instagram Post'; break; case '2': platformName = 'Instagram Story'; break;
                 case '3': platformName = 'TikTok Post'; break; case '4': platformName = 'Facebook'; break;
                 case '5': platformName = 'Twitter'; break;
                 default: alert("Invalid selection."); return;
             }
             alert(`Attempting to share to ${platformName}... (Check terminal)`);
             try {
                 const response = await fetch('/api/share', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ imagePath: simplePreviewImagePath, caption: finalCaption, platform: platformName }) });
                 const shareData = await response.json();
                 if (shareData.error) { alert(`Share Failed: ${shareData.error}`); } else { alert(`✅ SUCCESS: ${shareData.message}`); }
             } catch (error) { console.error('Sharing error:', error); alert('Network error during sharing.'); }
         }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase Loop Records Curator</title>
    <style>
        /* Base Styling + News List Image */
        body { font-family: Arial, sans-serif; background-color: #000000; color: #f0f0f0; margin: 0; padding: 20px; }
        .container { max-width: 600px; margin: auto; }
        h1, h2, h3 { color: #ffffff; border-bottom: 2px solid #555; padding-bottom: 10px; text-align: center; margin-bottom: 15px; }
        h3 { border-bottom: none; font-size: 1.1em; }
        .article { background-color: #111111; padding: 15px; margin-bottom: 10px; border-radius: 8px; cursor: pointer; border: 1px solid #333; display: flex; align-items: center; }
        .article-content { flex-grow: 1; }
        .article h2 { margin-top: 0; font-size: 1.2em; color: #ffffff; border-bottom: none; text-align: left; margin-bottom: 5px; }
        .article p { font-size: 0.8em; color: #ccc; margin-top: 0;}
        .article-image { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; margin-right: 15px; flex-shrink: 0; }

        /* UI State & Image Grid + Context Links */
        .hidden { display: none; }
        .image-selection-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 10px; }
        .image-container { display: flex; flex-direction: column; align-items: center; }
        .image-container img { width: 100%; height: 120px; object-fit: cover; cursor: pointer; border: 3px solid transparent; border-radius: 4px; margin-bottom: 5px; }
        .image-container img:hover { border-color: #555; }
        .image-container a { display: block; text-decoration: none; color: #aaa; font-size: 0.7em; text-align: center; margin-top: 2px; word-break: break-all; }
        .image-keyword { display: block; color: #777; font-size: 0.6em; text-align: center; margin-top: 1px; font-style: italic; }

        /* AI Text Preview Styling + Original Link */
        #ai-text-preview { padding: 15px; background-color: #1a1a1a; margin-bottom: 10px; border-radius: 4px; border: 1px solid #333; }
        #preview-headline { margin-top: 0; color: #FF6B6B; font-size: 1.4em; border-bottom: none; text-align: left;}
        #preview-description { font-size: 0.9em; color: #eee; margin-bottom: 10px;}
        #preview-caption-text { margin-top: 10px; font-style: italic; font-size: 0.9em; border-top: 1px dashed #333; padding-top: 10px; }
        #original-article-link-container { margin-bottom: 20px; text-align: center; font-size: 0.9em;}
        #original-article-link-container a { color: #87CEFA; text-decoration: none; }
        #original-article-link-container a:hover { text-decoration: underline; }
	
	/* Add this within the <style> tags */
        .image-dimensions {
             display: block; color: #666; font-size: 0.6em; text-align: center;
             margin-top: 1px;
        }

        #original-image-container img { width: 100%; max-width: 400px; margin: 10px auto; display: block; border: 2px solid #444; cursor: pointer; }
        #related-articles-list { display: flex; flex-direction: column; gap: 8px; }
        .related-article { background-color: #222; padding: 10px; border-radius: 4px; }
        .related-article a { color: #87CEFA; text-decoration: none; font-size: 0.9em; }
        .related-article p { font-size: 0.8em; color: #999; margin: 5px 0 0 0; }
        #video-display-area { margin-top: 20px; margin-bottom: 20px; }
        #video-display-area iframe,
        #video-display-area video { width: 100%; max-width: 560px; aspect-ratio: 16 / 9; display: block; margin: 0 auto; border: 1px solid #333; border-radius: 4px; }
        button { padding: 10px 15px; background-color: #007bff; color: white; border: none; cursor: pointer; border-radius: 4px; font-weight: bold; margin-top: 5px; }
        button:hover { background-color: #0056b3; }
        button#refresh-images-btn { background-color: #28a745; margin-left: 10px; }
        button#download-preview-btn { background-color: #17a2b8; margin-right: 10px; }
        button.back-button { background-color: #6c757d; margin-left: 10px;}
        button#share-preview-btn { background-color: #007bff; margin-right: 10px;}
        button#copy-caption-btn { background-color: #6f42c1; }
        button#copy-caption-btn:hover { background-color: #5a2e9b; }
        #simple-preview-image { width: 100%; max-width: 600px; margin: auto; display: block; margin-bottom: 20px; }
        #ai-caption-display { background-color: #1a1a1a; padding: 15px; margin-top: 20px; border-radius: 4px; border: 1px solid #333; }
        #ai-caption-display h3 { margin-top: 0; color: #FF6B6B; font-size: 1.4em; border-bottom: none; text-align: left;}
        #ai-caption-display #caption-text-area { width: 100%; height: 120px; background-color: #222; color: #f0f0f0; border: 1px solid #444; padding: 10px; box-sizing: border-box; resize: vertical; font-family: Arial, sans-serif; font-size: 0.9em; margin-bottom: 10px;}
        #simple-preview-video-player { width: 100%; max-width: 600px; aspect-ratio: 16 / 9; margin: auto; display: none; margin-bottom: 20px; border: 1px solid #444;}
    </style>
</head>
<body>
    <div class="container">
        <h1>PHASE LOOP RECORDS NEWS FEED</h1>
        <p>Tap a headline to create the social media post.</p>

        <div id="news-list"> Loading news... </div>

        <div id="selection-view" class="hidden">
             <h2>Select Your Post Visual</h2>
             <div id="ai-text-preview">
                 <h3 id="preview-headline">Generating AI text...</h3>
                 <p id="preview-description"></p>
                 <p id="preview-caption-text"></p>
             </div>
             <div id="original-article-link-container">
                 <a id="original-article-link" href="#" target="_blank" rel="noopener noreferrer">View Original Article</a>
             </div>
             <div id="original-image-container" class="hidden">
                 <h3>Original Article Image:</h3>
                 <img id="original-image" src="" alt="Original Article Image" />
             </div>
             <h3>Relevant Web Images: <button id="refresh-images-btn" disabled>Refresh</button></h3>
             <div id="image-selection-area" class="image-selection-grid">
                 <p>Generating AI text to determine search query...</p>
             </div>
             <div id="video-display-area" class="hidden">
                <h3>Related Video:</h3>
                <div id="video-player-container"></div>
             </div>
             <h3>Other Sources:</h3>
             <div id="related-articles-list">
                 <p>Finding related articles...</p>
             </div>
        </div>

        <div id="simple-preview-view" class="hidden">
            <h2>Quick Preview</h2>
            <img id="simple-preview-image" src="" alt="Simple Preview" />
            <div id="simple-preview-video-player" style="display: none;"></div>

            <div id="ai-caption-display">
                <h3>AI Caption:</h3>
                <textarea id="caption-text-area" readonly></textarea>
                <button id="copy-caption-btn">Copy Caption</button>
            </div>

            <button id="share-preview-btn">Share Post</button>
            <button id="download-preview-btn">Download Image</button>
            <button onclick="setView('select')" class="back-button">Back to Selection</button>
        </div>

    </div>

<script>
        // --- Global State Variables ---
        let currentArticleData = null;
        let currentCuratedData = null;
        let simplePreviewImagePath = null;
        let currentVideoUrl = null;
        const IMAGES_PER_PAGE = 9;
        let currentSearchKeywords = []; // Array of keywords tried
        let currentKeywordIndex = 0;    // Index of the keyword currently being used
        let refreshClicksOnCurrentKeyword = 0; // Clicks since last keyword change (0, 1, 2)
        let currentImageStartIndex = 0; // 0-based index for pagination within current keyword

        // --- Event Listener for DOM Load ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM fully loaded and parsed. Calling fetchNews()...");
            fetchNews();

            // --- Button Listeners ---
            document.getElementById('refresh-images-btn').onclick = () => {
                if (currentSearchKeywords.length === 0 || !currentCuratedData) {
                    alert('Cannot refresh: search keywords not set or AI data missing.'); return;
                }
                refreshClicksOnCurrentKeyword++;
                if (refreshClicksOnCurrentKeyword < 3) {
                    currentImageStartIndex += IMAGES_PER_PAGE;
                    const currentKeyword = currentSearchKeywords[currentKeywordIndex];
                    console.log(`[Refresh] Loading next images for "${currentKeyword}", starting at index ${currentImageStartIndex}`);
                    fetchImages(currentKeyword, currentImageStartIndex);
                } else {
                    console.log(`[Refresh] Reached 3 clicks, requesting alternative keywords...`);
                    document.getElementById('refresh-images-btn').disabled = true;
                    fetchAlternativeKeywords();
                }
            };
            document.getElementById('download-preview-btn').onclick = () => handleDownload();
            document.getElementById('share-preview-btn').onclick = () => handleShare();
            document.getElementById('copy-caption-btn').onclick = () => handleCopyCaption();
        });

        // --- UI View Handler ---
        function setView(viewId) {
            console.log(`setView called with ID: ${viewId}`);
            const newsList = document.getElementById('news-list');
            const selectionView = document.getElementById('selection-view');
            const simplePreviewView = document.getElementById('simple-preview-view');
            if (!newsList || !selectionView || !simplePreviewView) {
                console.error("setView Error: One or more view elements not found!"); return;
            }
            console.log("setView: Found all view elements.");
            newsList.classList.add('hidden'); selectionView.classList.add('hidden'); simplePreviewView.classList.add('hidden');
            console.log("setView: Added 'hidden' to all views.");
            if (viewId === 'list') { newsList.classList.remove('hidden'); console.log("setView: Showing 'news-list'."); }
            else if (viewId === 'select') { selectionView.classList.remove('hidden'); console.log("setView: Showing 'selection-view'."); }
            else if (viewId === 'simple-preview') {
                simplePreviewView.classList.remove('hidden'); console.log("setView: Showing 'simple-preview-view'.");
                populateCaptionDisplay();
                const downloadBtn = document.getElementById('download-preview-btn');
                const imgPreview = document.getElementById('simple-preview-image');
                const videoPreview = document.getElementById('simple-preview-video-player');
                if (currentVideoUrl) { imgPreview.style.display = 'none'; videoPreview.style.display = 'block'; downloadBtn.textContent = 'Download/Open Video'; }
                else { imgPreview.style.display = 'block'; videoPreview.style.display = 'none'; downloadBtn.textContent = 'Download Image'; }
            }
        }

        // --- Fetch Initial News Feed ---
        async function fetchNews() {
            console.log("fetchNews function STARTED.");
            const newsListElement = document.getElementById('news-list');
            if (!newsListElement) { console.error("CRITICAL ERROR: news-list element NOT FOUND!"); alert("Page structure error."); return; }
            newsListElement.innerHTML = 'Loading news...';
            console.log("Set 'Loading news...' text.");
            try {
                console.log("Inside try block, BEFORE fetch('/api/news')");
                const response = await fetch('/api/news');
                console.log("AFTER fetch('/api/news'), Status:", response.status);
                if (!response.ok) { console.error("Fetch response NOT ok:", response.status); throw new Error(`HTTP error! status: ${response.status}`); }
                console.log("Response OK. Trying response.json()...");
                const articles = await response.json();
                console.log("Successfully parsed JSON. Number of articles:", articles ? articles.length : 'null/undefined');
                if (!articles || articles.length === 0) { newsListElement.innerHTML = '<p>No news articles found.</p>'; console.log("No articles found."); return; }
                newsListElement.innerHTML = '';
                console.log("Cleared loading message. Starting article loop...");
                articles.forEach((article, index) => {
                    const articleElement = document.createElement('div'); articleElement.className = 'article'; articleElement.dataset.link = article.link;
                    const imgElement = document.createElement('img'); imgElement.className = 'article-image'; imgElement.src = article.originalImageUrl || '/fallback-thumbnail.png'; imgElement.alt = 'Article thumbnail'; imgElement.onerror = function() { this.src='/fallback-thumbnail.png'; };
                    const contentElement = document.createElement('div'); contentElement.className = 'article-content'; contentElement.innerHTML = `<h2>${article.title}</h2><p>Source: ${article.source} | Published: ${new Date(article.pubDate).toLocaleDateString()}</p>`;
                    articleElement.appendChild(imgElement); articleElement.appendChild(contentElement);
                    articleElement.onclick = () => handleArticleTap(article); // Correctly defined here
                    newsListElement.appendChild(articleElement);
                });
                console.log("Finished processing all articles.");
            } catch (error) { console.error('!!! CATCH ERROR inside fetchNews:', error); newsListElement.innerHTML = '<p style="color: red;">Failed to load news. Check console.</p>'; }
        }

        // --- Handle Article Selection ---
        async function handleArticleTap(article) {
            console.log("handleArticleTap called for:", article.title);
            currentArticleData = article; currentCuratedData = null; currentVideoUrl = null; simplePreviewImagePath = null;
            currentSearchKeywords = []; currentKeywordIndex = 0; refreshClicksOnCurrentKeyword = 0; currentImageStartIndex = 0;
            document.getElementById('refresh-images-btn').disabled = true;
            setView('select');
            document.getElementById('preview-headline').innerText = "Generating AI text..."; document.getElementById('preview-description').innerText = ""; document.getElementById('preview-caption-text').innerText = "";
            document.getElementById('image-selection-area').innerHTML = "<p>Generating AI text to determine search query...</p>"; document.getElementById('related-articles-list').innerHTML = "<p>Finding related articles...</p>";
            document.getElementById('video-display-area').classList.add('hidden'); document.getElementById('video-player-container').innerHTML = ''; document.getElementById('original-image-container').classList.add('hidden');
            const originalLinkEl = document.getElementById('original-article-link'); originalLinkEl.href = article.link; originalLinkEl.textContent = `View Original Article on ${article.source}`;
            fetchAiText(article); // Trigger AI flow
            fetchRelatedArticles(article.title, article.source); fetchVideo(article.title, article.source, article.videoUrl);
            if (article.originalImageUrl) { const originalImgEl = document.getElementById('original-image'); const originalImgContainer = document.getElementById('original-image-container'); originalImgEl.src = article.originalImageUrl; originalImgEl.onclick = () => startSimplePreviewPipeline(article.originalImageUrl); originalImgContainer.classList.remove('hidden'); }
        }

        // --- Fetch AI Text & Trigger Keyword Extraction ---
        async function fetchAiText(article) {
            console.log("fetchAiText function STARTED.");
            const previewHeadlineEl = document.getElementById('preview-headline'); const previewDescriptionEl = document.getElementById('preview-description'); const previewCaptionEl = document.getElementById('preview-caption-text'); const imageSelectionArea = document.getElementById('image-selection-area');
            if (!previewHeadlineEl || !previewDescriptionEl || !previewCaptionEl || !imageSelectionArea) { console.error("fetchAiText Error: Preview elements not found!"); return; }
            previewHeadlineEl.innerText = "Generating AI text..."; previewDescriptionEl.innerText = ""; previewCaptionEl.innerText = ""; imageSelectionArea.innerHTML = "<p>Generating AI text to determine search query...</p>";
            console.log("fetchAiText: Set initial 'Generating AI text...' messages.");
            try {
                console.log("fetchAiText: Sending request to /api/generate-text for:", article.title);
                const response = await fetch('/api/generate-text', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(article) });
                console.log("fetchAiText: AFTER fetch('/api/generate-text'), Status:", response.status);
                if (!response.ok) { const errorText = await response.text(); console.error("fetchAiText: Fetch response NOT ok:", response.status, errorText); throw new Error(`HTTP error! ${response.status} - ${errorText}`); }
                console.log("fetchAiText: Response OK. Parsing JSON...");
                currentCuratedData = await response.json();
                console.log("fetchAiText: Successfully parsed AI text response:", currentCuratedData);
                previewHeadlineEl.innerText = currentCuratedData.headline || "AI Failed headline."; previewDescriptionEl.innerText = currentCuratedData.description || "No description."; previewCaptionEl.innerText = (currentCuratedData.caption || "No caption.") + `\n\nNews Source: ${currentCuratedData.originalSource || 'Unknown'}`;
                console.log("fetchAiText: Populated AI text to UI.");
                if (currentCuratedData.headline && currentCuratedData.headline !== "AI Failed") { console.log("fetchAiText: Calling fetchPrimaryKeywords..."); fetchPrimaryKeywordsAndStartImageSearch(currentCuratedData.headline, currentCuratedData.description); }
                else { imageSelectionArea.innerHTML = "<p>AI text failed, cannot search images.</p>"; console.warn("fetchAiText: AI failed."); }
            } catch (error) { console.error('!!! CATCH ERROR inside fetchAiText:', error); previewHeadlineEl.innerText = "Error Generating AI Text"; /* ... set error messages ... */ imageSelectionArea.innerHTML = "<p>Error generating AI text.</p>"; }
        }

        // --- Fetch Primary Keywords & Start Image Search ---
        async function fetchPrimaryKeywordsAndStartImageSearch(headline, description) {
            document.getElementById('image-selection-area').innerHTML = '<p>Extracting primary keywords...</p>';
            try {
                console.log("fetchPrimaryKeywords: Sending request to /api/extract-keywords");
                const response = await fetch('/api/extract-keywords', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ headline, description }) });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                let primaryKeyword = data.keywords;
                if (!primaryKeyword) { console.warn("[Keywords] Primary extraction failed, falling back."); primaryKeyword = currentArticleData.title; document.getElementById('image-selection-area').innerHTML = '<p>Keyword extraction failed, using title...</p>'; }
                currentSearchKeywords = [primaryKeyword]; currentKeywordIndex = 0; refreshClicksOnCurrentKeyword = 0; currentImageStartIndex = 0;
                console.log(`[Keywords] Received primary: "${primaryKeyword}", starting image search.`);
                fetchImages(primaryKeyword, 0);
            } catch (error) { console.error("Error fetching primary keywords:", error); console.warn("[Keywords] Fetch failed, falling back."); currentSearchKeywords = [currentArticleData.title]; currentKeywordIndex = 0; refreshClicksOnCurrentKeyword = 0; currentImageStartIndex = 0; document.getElementById('image-selection-area').innerHTML = '<p>Keyword fetch failed, using title...</p>'; fetchImages(currentArticleData.title, 0); }
        }

        // --- Fetch Alternative Keywords ---
        async function fetchAlternativeKeywords() {
            if (!currentCuratedData) { alert("Cannot get alternative keywords."); document.getElementById('refresh-images-btn').disabled = false; return; }
            const area = document.getElementById('image-selection-area');
            area.innerHTML += '<p>Searching for alternative keywords...</p>';
            try {
                console.log("fetchAlternativeKeywords: Sending request to /api/get-alternative-keywords");
                const response = await fetch('/api/get-alternative-keywords', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ headline: currentCuratedData.headline, description: currentCuratedData.description, previousKeywords: currentSearchKeywords }) });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                if (data.keywords) { const newKeyword = data.keywords; console.log(`[AltKeywords] Received alternative: "${newKeyword}"`); currentSearchKeywords.push(newKeyword); currentKeywordIndex++; refreshClicksOnCurrentKeyword = 0; currentImageStartIndex = 0; fetchImages(newKeyword, 0); }
                else { console.warn("[AltKeywords] No suitable alternative found."); alert("No more alternative keywords found."); area.innerHTML += '<p>No alternative keywords found.</p>'; document.getElementById('refresh-images-btn').disabled = true; }
            } catch (error) { console.error("Error fetching alternative keywords:", error); alert("Failed to get alternative keywords."); area.innerHTML += '<p>Failed to get alternative keywords.</p>'; document.getElementById('refresh-images-btn').disabled = true; }
        }

	// --- Fetch Images (DISPLAY DIMENSIONS) ---
        async function fetchImages(query, startIndex) {
            // ... (loading message logic - unchanged) ...
            try {
                // ... (fetch call - unchanged) ...
                const data = await response.json();
                const imagesData = data.images || []; // Now expects {imageUrl, contextUrl, query, width, height}
                // ... (clear loading message - unchanged) ...

                if (imagesData.length === 0) { /* ... handle no results ... */ }
                else {
                    refreshBtn.disabled = (imagesData.length < IMAGES_PER_PAGE);
                    imagesData.forEach((imgData, index) => {
                         const container = document.createElement('div');
                         container.className = 'image-container';

                         const img = document.createElement('img'); /* ... set src, alt, etc ... */
                         img.onclick = () => startSimplePreviewPipeline(imgData.imageUrl); // Ensure this line is present and correct

                         const link = document.createElement('a'); /* ... set href, text, etc ... */
                         const keywordSpan = document.createElement('span'); /* ... set class, text ... */

                         // *** Add Dimensions Display ***
                         const dimensionsSpan = document.createElement('span');
                         dimensionsSpan.className = 'image-dimensions';
                         if (imgData.width && imgData.height) {
                            dimensionsSpan.textContent = `${imgData.width} x ${imgData.height}`;
                         } else {
                            dimensionsSpan.textContent = `Dimensions N/A`;
                         }
                         // *** End Add ***

                         container.appendChild(img);
                         container.appendChild(link);
                         container.appendChild(keywordSpan);
                         container.appendChild(dimensionsSpan); // Add dimensions span
                         area.appendChild(container);
                     });
                 }
            } catch (error) { /* ... error handling ... */ }
        }

	// --- Fetch Related Articles (ADD LOGGING) ---
        async function fetchRelatedArticles(title, source) {
            const list = document.getElementById('related-articles-list');
            if (!list) { console.error("fetchRelatedArticles Error: List element not found!"); return; } // Check element existence
            list.innerHTML = "<p>Finding related articles...</p>";
            console.log(`fetchRelatedArticles: Searching for articles related to "${title}" from "${source}"`); // Log Start

            try {
                const response = await fetch('/api/find-related-articles', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title: title, source: source }) // Send title AND source
                });
                console.log(`fetchRelatedArticles: Response Status: ${response.status}`); // Log Status

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const data = await response.json();
                console.log("fetchRelatedArticles: Received data:", data); // Log Received Data

                const relatedArticles = data.relatedArticles || [];

                list.innerHTML = ''; // Clear loading
                if (relatedArticles.length === 0) {
                    list.innerHTML = "<p>No other sources found.</p>";
                    console.log("fetchRelatedArticles: No related articles found in response."); // Log No Results
                    return;
                }
                console.log(`fetchRelatedArticles: Rendering ${relatedArticles.length} articles.`); // Log Rendering Start

                relatedArticles.forEach(article => {
                    if (article.link === currentArticleData.link) return; // Skip self

                    const el = document.createElement('div');
                    el.className = 'related-article';
                    el.innerHTML = `<a href="${article.link}" target="_blank" rel="noopener noreferrer">${article.title}</a><p>${article.source}</p>`;
                    list.appendChild(el);
                });
                console.log("fetchRelatedArticles: Finished rendering."); // Log Rendering End

            } catch (error) {
                console.error('!!! CATCH ERROR fetching related articles:', error); // Log Catch Error
                list.innerHTML = "<p style='color: red;'>Related article search failed. Check console.</p>";
            }
        }

        // --- Fetch Video ---
        async function fetchVideo(title, source, rssVideoUrl) { /* ... unchanged ... */ }
        // --- Display Video ---
        function displayVideo(videoUrl, containerId) { /* ... unchanged ... */ }

// --- Call Simple Preview API (ADD LOGGING) ---
        async function startSimplePreviewPipeline(mediaUrl) {
            console.log(`startSimplePreviewPipeline called with URL: ${mediaUrl}`); // Log Function Start

            // Determine if it's an image or video URL
            const isVideo = currentVideoUrl && mediaUrl === currentVideoUrl;
            const isImageUrl = !isVideo;

            console.log(`startSimplePreviewPipeline: Is Video? ${isVideo}, Is Image? ${isImageUrl}`); // Log Type

            currentVideoUrl = isVideo ? mediaUrl : null;
            simplePreviewImagePath = isImageUrl ? 'generating' : null;

            try {
                 if (isImageUrl) {
                    if (!currentCuratedData) { alert("AI text needed..."); return; }
                    alert("Generating preview image..."); // Alert should appear if called
                    console.log("startSimplePreviewPipeline: Proceeding with image generation."); // Log Image Path
                    const headline = (currentCuratedData.headline || "N/A").replace(/^\*\*|\*\*$/g, '');
                    const description = currentCuratedData.description; // Use the short_description
                    const response = await fetch('/api/generate-simple-preview', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ imageUrl: mediaUrl, headline, description }) });
                    // ... (rest of image generation try block) ...
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const previewData = await response.json();
                    if (previewData.error || previewData.previewImagePath === '/fallback.png') { alert('Preview Error.'); console.error('Preview generation failed on server.'); return; } // Add console error
                    simplePreviewImagePath = previewData.previewImagePath;
                    console.log(`startSimplePreviewPipeline: Image generated: ${simplePreviewImagePath}`); // Log Success
                 }
                 else if (isVideo) {
                     alert("Preparing video preview..."); // Alert should appear if called
                     console.log("startSimplePreviewPipeline: Setting up video preview."); // Log Video Path
                     displayVideo(mediaUrl, 'simple-preview-video-player');
                 }

                 // Check if either path exists or video exists
                 if (simplePreviewImagePath || currentVideoUrl) {
                    console.log("startSimplePreviewPipeline: Setting view to 'simple-preview'."); // Log View Change
                    setView('simple-preview');
                    if (simplePreviewImagePath) {
                         document.getElementById('simple-preview-image').src = simplePreviewImagePath + '?' + Date.now();
                    }
                    currentImageStartIndex = 0; refreshClicksOnCurrentKeyword = 0; document.getElementById('refresh-images-btn').disabled = false;
                 } else {
                     console.warn("startSimplePreviewPipeline: No image path or video URL set after processing."); // Log if nothing happened
                 }

            } catch (error) {
                 console.error('!!! CATCH ERROR in simple preview pipeline:', error); // Log Catch Error
                 alert('Failed to create preview. Check console.');
                 simplePreviewImagePath = null; // Reset on error
            }
        }

        // --- Populate Caption Display ---
        function populateCaptionDisplay() { /* ... unchanged ... */ }
        // --- Handle Copy Caption ---
        async function handleCopyCaption() { /* ... unchanged ... */ }
        // --- Share Button Logic ---
        async function handleShare() { /* ... unchanged ... */ }
        // --- Download Button Logic ---
        function handleDownload() { /* ... unchanged ... */ }

    </script></body></html>
